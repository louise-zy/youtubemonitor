name: Daily YouTube RSS Monitor

on:
  schedule:
    # 每天北京时间早上 8:00 运行 (UTC 0:00)
    - cron: '0 0 * * *'
  workflow_dispatch:  # 允许手动触发

jobs:
  run_monitor:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # 需要写权限来提交数据库更改
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # 确保安装 ffmpeg (yt-dlp 最好有它)
        sudo apt-get update && sudo apt-get install -y ffmpeg

    - name: Run Monitor
      env:
        # 配置环境变量覆盖 config.json
        # 注意：需要在 GitHub 仓库 Settings -> Secrets and variables -> Actions 中设置这些 Secrets
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        OPENAI_API_BASE: ${{ secrets.OPENAI_API_BASE }}
        DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
        DINGTALK_SECRET: ${{ secrets.DINGTALK_SECRET }}
        # 可选：如果需要 Cookies
        YOUTUBE_COOKIES_FILE: ${{ secrets.YOUTUBE_COOKIES_FILE }}
      run: |
        python youtube_rss_monitor.py --once

    - name: Commit and push DB changes
      run: |
        git config --global user.name 'GitHub Action'
        git config --global user.email 'action@github.com'
        git add youtube_rss.db
        # 只有当有变化时才提交
        git diff --quiet && git diff --staged --quiet || (git commit -m "Update database state [skip ci]" && git push)
